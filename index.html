<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWï¼’.ï¼•ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --bg-color: #0f172a;
            --surface-color: #1e293b;
            --text-color: #f8fafc;
            --border-color: #334155;
            --accent: #10b981;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* justify-content: center; */
            /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç”»é¢å¤–ã«æŠ¼ã—å‡ºã•ã‚Œã‚‹åŸå› ã¨ãªã‚‹ãŸã‚å‰Šé™¤ */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--surface-color);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .container:hover {
            transform: translateY(-5px);
        }

        h1 {
            margin-top: 0;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .control-btn {
            background-color: var(--border-color);
            color: var(--text-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background-color: var(--primary);
            transform: scale(1.1);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            background-color: var(--border-color);
        }

        .dice-count-display {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 80px;
            background: var(--bg-color);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .roll-btn-container {
            display: flex;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }

        .roll-btn {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            flex: 2;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .fate-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            flex: 1;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .fate-btn:disabled {
            background: #4b5563;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .roll-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }

        .roll-btn:active {
            transform: translateY(1px);
        }

        .results-area {
            margin-top: 40px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Webhookè¨­å®šç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .setting-section {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        .setting-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pc-name-container {
            margin-bottom: 20px;
            width: 100%;
        }

        .pc-name-input {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .pc-name-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .webhook-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .webhook-url-input {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            box-sizing: border-box;
        }

        .webhook-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .dice-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .die {
            width: 60px;
            height: 60px;
            background-color: var(--text-color);
            color: var(--bg-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            box-shadow: inset 0 -4px 0 rgba(0, 0, 0, 0.1), 0 4px 10px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: scale(0.5) rotate(180deg);
        }

        .die.show {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .die.rolling {
            animation: shake 0.4s infinite;
        }

        @keyframes shake {
            0% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(15deg);
            }

            50% {
                transform: rotate(0deg);
            }

            75% {
                transform: rotate(-15deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes popIn {
            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .total-score {
            font-size: 3rem;
            font-weight: 800;
            color: var(--accent);
            opacity: 0;
            transform: translateY(20px);
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        .total-score.show {
            animation: slideUp 0.6s ease forwards;
            animation-delay: 0.2s;
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .history {
            margin-top: 30px;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            text-align: left;
            font-size: 0.9rem;
            color: #94a3b8;
            max-height: 150px;
            overflow-y: auto;
        }

        .history-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
        }

        /* Scrollbar styles for history */
        .history::-webkit-scrollbar {
            width: 6px;
        }

        .history::-webkit-scrollbar-track {
            background: var(--surface-color);
        }

        .history::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .history::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        .rating-table-wrapper {
            margin-top: 15px;
            margin-bottom: 25px;
            width: 100%;
            overflow-x: auto;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .rating-table-wrapper.show {
            display: block;
        }

        .rating-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            table-layout: fixed;
        }

        .rating-table th,
        .rating-table td {
            border: 1px solid var(--border-color);
            padding: 6px 2px;
            text-align: center;
        }

        .rating-table th {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--text-color);
            font-weight: 600;
        }

        .rating-table td {
            color: var(--accent);
            font-weight: bold;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .power-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            opacity: 0.5;
            transition: opacity 0.3s;
        }

        .power-input-group.active {
            opacity: 1;
        }

        .power-input {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 1.1rem;
            width: 80px;
            text-align: center;
        }

        .power-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .weapon-inputs-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 0.6fr 1.4fr;
            gap: 10px;
            margin-bottom: 10px;
            width: 100%;
        }

        .weapon-inputs-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
            width: 100%;
        }

        .weapon-input-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .weapon-label {
            font-size: 0.75rem;
            margin-bottom: 4px;
            color: #94a3b8;
        }

        .round-tracker {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .round-label {
            font-weight: bold;
            color: var(--text-color);
            margin-right: -5px;
        }

        .buff-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
            width: 100%;
        }

        .buff-item {
            display: flex;
            align-items: center;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 5px;
            gap: 5px;
        }

        .buff-name {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 0.9rem;
            padding: 5px;
            outline: none;
        }

        .buff-name::placeholder {
            color: #64748b;
        }

        .buff-value,
        .buff-duration {
            width: 45px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9rem;
            text-align: center;
            outline: none;
        }

        .buff-duration {
            width: 50px;
            color: #fbbf24;
            /* highlight for duration */
        }

        .buff-value:focus,
        .buff-duration:focus,
        .buff-name:focus {
            border-color: var(--primary);
        }

        /* èƒ½åŠ›å€¤ãƒ»æŠ€èƒ½ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .status-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
            text-align: left;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: auto auto 1fr 1fr;
            gap: 8px;
            align-items: center;
        }

        .stats-label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: bold;
        }

        .stats-input {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9rem;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .skills-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skill-item {
            display: grid;
            grid-template-columns: auto 1fr 45px;
            gap: 5px;
            align-items: center;
        }

        .skill-name {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.9rem;
        }

        .skill-level {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--accent);
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9rem;
            text-align: center;
            font-weight: bold;
        }

        /* åˆ¤å®šç”¨é¸æŠã‚¹ã‚¿ã‚¤ãƒ« */
        .clickable-stat,
        .clickable-skill {
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            padding: 4px;
            text-align: center;
            user-select: none;
            width: 24px;
            height: 24px;
            line-height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
        }

        .clickable-stat:hover,
        .clickable-skill:hover {
            background-color: rgba(99, 102, 241, 0.2);
            transform: scale(1.1);
        }

        .selected-item {
            background-color: var(--primary) !important;
            color: white !important;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }

        .file-input-wrapper {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }

        .file-label {
            background-color: var(--surface-color);
            border: 1px dashed var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-label:hover {
            background-color: rgba(99, 102, 241, 0.1);
            border-style: solid;
        }

        #json-upload {
            display: none;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                border-radius: 10px;
            }

            .status-container {
                grid-template-columns: 1fr;
                gap: 25px;
            }

            .buff-container {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.5rem;
            }

            .total-score {
                font-size: 1.5rem !important;
            }
        }

        /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆæ­¦å™¨ãƒ»é­”æ³•ã‚»ãƒƒãƒˆï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .accordion-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.03);
            transition: all 0.3s ease;
            width: 100%;
            text-align: left;
        }

        .accordion-header {
            padding: 12px 18px;
            background-color: rgba(99, 102, 241, 0.1);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.95rem;
            color: var(--text-color);
            border-bottom: 1px solid transparent;
        }

        .accordion-header:hover {
            background-color: rgba(99, 102, 241, 0.2);
        }

        .accordion-header::after {
            content: 'â–¼';
            font-size: 0.7rem;
            transition: transform 0.3s;
            color: var(--primary);
        }

        .accordion-item.collapsed .accordion-header::after {
            transform: rotate(-90deg);
        }

        .accordion-item:not(.collapsed) .accordion-header {
            border-bottom-color: var(--border-color);
            background-color: rgba(99, 102, 241, 0.15);
        }

        .accordion-content {
            padding: 15px;
            display: block;
        }

        .accordion-item.collapsed .accordion-content {
            display: none;
        }

        .weapon-title-tag {
            font-size: 0.8rem;
            font-weight: normal;
            color: var(--accent);
            margin-left: 10px;
            border: 1px solid var(--accent);
            padding: 1px 6px;
            border-radius: 4px;
        }

        /* å¨åŠ›ç®—å‡ºãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .power-input-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            width: 100%;
        }

        .calc-btn {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 6px;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            padding: 0;
            flex-shrink: 0;
        }

        .calc-btn:hover {
            background-color: var(--primary);
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .calc-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>SWï¼’.ï¼•ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼</h1>

        <div class="pc-name-container">
            <input type="text" id="pc-name" class="pc-name-input" placeholder="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å…¥åŠ›">
        </div>

        <div class="setting-section">
            <div class="setting-title">
                <span>ğŸ”— Discordé€£æºè¨­å®š</span>
            </div>
            <div class="webhook-input-group">
                <input type="password" id="webhook-url" class="webhook-url-input" placeholder="Webhook URLã‚’å…¥åŠ›">
                <div class="webhook-controls">
                    <label class="checkbox-container">
                        <input type="checkbox" id="webhook-enable"> Discordã«é€ä¿¡ã™ã‚‹
                    </label>
                    <span id="webhook-status" style="font-size: 0.75rem; color: #94a3b8;"></span>
                </div>
            </div>
        </div>

        <div class="file-input-wrapper">
            <label for="json-upload" class="file-label">
                <span>ğŸ“ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼JSONã‚’èª­ã¿è¾¼ã‚€</span>
                <input type="file" id="json-upload" accept=".json">
            </label>
            <button id="json-download" class="file-label"
                style="margin-left: 10px; border: 1px solid var(--accent); color: var(--accent); background: transparent; cursor: pointer;">
                <span>ğŸ’¾ ç¾åœ¨ã®çŠ¶æ…‹ã‚’JSONã§ä¿å­˜</span>
            </button>
        </div>

        <div class="controls">
            <button id="decrease-btn" class="control-btn" aria-label="ãƒ€ã‚¤ã‚¹ã‚’æ¸›ã‚‰ã™">âˆ’</button>
            <div id="dice-count" class="dice-count-display">2d6</div>
            <button id="increase-btn" class="control-btn" aria-label="ãƒ€ã‚¤ã‚¹ã‚’å¢—ã‚„ã™">ï¼‹</button>
        </div>

        <div class="round-tracker">
            <span class="round-label">ãƒ©ã‚¦ãƒ³ãƒ‰</span>
            <button id="round-decrease" class="control-btn" aria-label="ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æ¸›ã‚‰ã™"
                style="width:35px; height:35px; font-size:1rem;">âˆ’</button>
            <div id="round-display" class="dice-count-display"
                style="min-width:50px; padding:5px 10px; font-size:1.2rem;">1</div>
            <button id="round-increase" class="control-btn" aria-label="ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å¢—ã‚„ã™"
                style="width:35px; height:35px; font-size:1rem;">ï¼‹</button>
        </div>

        <div class="roll-btn-container"
            style="display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap;">
            <button id="roll-btn" class="roll-btn">ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹</button>
            <button id="fate-btn" class="fate-btn" disabled>é‹å‘½å¤‰è»¢</button>
            <label
                style="display: flex; align-items: center; gap: 5px; cursor: pointer; color: var(--text-color); font-size: 0.9rem; margin-top: 5px; width: 100%; justify-content: center;">
                <input type="checkbox" id="dice-only-checkbox" style="width: 16px; height: 16px;">
                å‡ºç›®ã®ã¿å‡ºåŠ›
            </label>
        </div>

        <div class="results-area">
            <div id="dice-container" class="dice-container">
                <!-- Dice will appear here -->
            </div>
            <div id="total-score" class="total-score"></div>
        </div>

        <div class="status-container">
            <div class="stats-grid">
                <div class="stats-label">åˆ¤å®š</div>
                <div class="stats-label">èƒ½åŠ›å€¤</div>
                <div class="stats-label" style="text-align: center;">å€¤</div>
                <div class="stats-label" style="text-align: center;">B</div>

                <div class="clickable-stat" data-stat="dex">ğŸ”˜</div>
                <span>å™¨ç”¨</span>
                <input type="number" id="stt-dex" class="stats-input" placeholder="0">
                <input type="number" id="bonus-dex" class="stats-input" placeholder="0">

                <div class="clickable-stat" data-stat="agi">ğŸ”˜</div>
                <span>æ•æ·</span>
                <input type="number" id="stt-agi" class="stats-input" placeholder="0">
                <input type="number" id="bonus-agi" class="stats-input" placeholder="0">

                <div class="clickable-stat" data-stat="str">ğŸ”˜</div>
                <span>ç­‹åŠ›</span>
                <input type="number" id="stt-str" class="stats-input" placeholder="0">
                <input type="number" id="bonus-str" class="stats-input" placeholder="0">

                <div class="clickable-stat" data-stat="vit">ğŸ”˜</div>
                <span>ç”Ÿå‘½</span>
                <input type="number" id="stt-vit" class="stats-input" placeholder="0">
                <input type="number" id="bonus-vit" class="stats-input" placeholder="0">

                <div class="clickable-stat" data-stat="int">ğŸ”˜</div>
                <span>çŸ¥åŠ›</span>
                <input type="number" id="stt-int" class="stats-input" placeholder="0">
                <input type="number" id="bonus-int" class="stats-input" placeholder="0">

                <div class="clickable-stat" data-stat="mnd">ğŸ”˜</div>
                <span>ç²¾ç¥</span>
                <input type="number" id="stt-mnd" class="stats-input" placeholder="0">
                <input type="number" id="bonus-mnd" class="stats-input" placeholder="0">
            </div>

            <div class="skills-list">
                <div class="stats-label">ä¸»è¦æŠ€èƒ½ï¼ˆåˆ¤å®š ãƒœã‚¿ãƒ³ã‚’é¸æŠï¼‰</div>
                <div class="skill-item">
                    <div class="clickable-skill" data-skill-id="1">ğŸ”˜</div>
                    <input type="text" id="skill-name-1" class="skill-name" placeholder="æŠ€èƒ½å1">
                    <input type="number" id="skill-lv-1" class="skill-level" placeholder="0">
                </div>
                <div class="skill-item">
                    <div class="clickable-skill" data-skill-id="2">ğŸ”˜</div>
                    <input type="text" id="skill-name-2" class="skill-name" placeholder="æŠ€èƒ½å2">
                    <input type="number" id="skill-lv-2" class="skill-level" placeholder="0">
                </div>
                <div class="skill-item">
                    <div class="clickable-skill" data-skill-id="3">ğŸ”˜</div>
                    <input type="text" id="skill-name-3" class="skill-name" placeholder="æŠ€èƒ½å3">
                    <input type="number" id="skill-lv-3" class="skill-level" placeholder="0">
                </div>
                <div class="skill-item">
                    <div class="clickable-skill" data-skill-id="4">ğŸ”˜</div>
                    <input type="text" id="skill-name-4" class="skill-name" placeholder="æŠ€èƒ½å4">
                    <input type="number" id="skill-lv-4" class="skill-level" placeholder="0">
                </div>
                <div class="skill-item">
                    <div class="clickable-skill" data-skill-id="5">ğŸ”˜</div>
                    <input type="text" id="skill-name-5" class="skill-name" placeholder="æŠ€èƒ½å5">
                    <input type="number" id="skill-lv-5" class="skill-level" placeholder="0">
                </div>
            </div>
        </div>

        <div class="buff-container">
            <div class="buff-item">
                <input type="checkbox" class="buff-active-chk" checked title="æœ‰åŠ¹/ç„¡åŠ¹"
                    style="margin-right: 5px; cursor: pointer; width: 14px; height: 14px;">
                <select class="buff-target"
                    style="padding: 2px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pdmg">ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="mdmg">é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="hit">å‘½ä¸­</option>
                    <option value="dodge">å›é¿</option>
                    <option value="vit">ç”Ÿå‘½åŠ›</option>
                    <option value="int">çŸ¥åŠ›</option>
                    <option value="mnd">ç²¾ç¥åŠ›</option>
                </select>
                <input type="text" class="buff-name" placeholder="ãƒãƒ•/ãƒ‡ãƒãƒ•å">
                <input type="number" class="buff-value" placeholder="å€¤">
                <input type="number" class="buff-duration" placeholder="R" min="1" title="æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰">
            </div>
            <div class="buff-item">
                <input type="checkbox" class="buff-active-chk" checked title="æœ‰åŠ¹/ç„¡åŠ¹"
                    style="margin-right: 5px; cursor: pointer; width: 14px; height: 14px;">
                <select class="buff-target"
                    style="padding: 2px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pdmg">ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="mdmg">é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="hit">å‘½ä¸­</option>
                    <option value="dodge">å›é¿</option>
                    <option value="vit">ç”Ÿå‘½åŠ›</option>
                    <option value="int">çŸ¥åŠ›</option>
                    <option value="mnd">ç²¾ç¥åŠ›</option>
                </select>
                <input type="text" class="buff-name" placeholder="ãƒãƒ•/ãƒ‡ãƒãƒ•å">
                <input type="number" class="buff-value" placeholder="å€¤">
                <input type="number" class="buff-duration" placeholder="R" min="1" title="æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰">
            </div>
            <div class="buff-item">
                <input type="checkbox" class="buff-active-chk" checked title="æœ‰åŠ¹/ç„¡åŠ¹"
                    style="margin-right: 5px; cursor: pointer; width: 14px; height: 14px;">
                <select class="buff-target"
                    style="padding: 2px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pdmg">ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="mdmg">é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="hit">å‘½ä¸­</option>
                    <option value="dodge">å›é¿</option>
                    <option value="vit">ç”Ÿå‘½åŠ›</option>
                    <option value="int">çŸ¥åŠ›</option>
                    <option value="mnd">ç²¾ç¥åŠ›</option>
                </select>
                <input type="text" class="buff-name" placeholder="ãƒãƒ•/ãƒ‡ãƒãƒ•å">
                <input type="number" class="buff-value" placeholder="å€¤">
                <input type="number" class="buff-duration" placeholder="R" min="1" title="æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰">
            </div>
            <div class="buff-item">
                <input type="checkbox" class="buff-active-chk" checked title="æœ‰åŠ¹/ç„¡åŠ¹"
                    style="margin-right: 5px; cursor: pointer; width: 14px; height: 14px;">
                <select class="buff-target"
                    style="padding: 2px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pdmg">ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="mdmg">é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="hit">å‘½ä¸­</option>
                    <option value="dodge">å›é¿</option>
                    <option value="vit">ç”Ÿå‘½åŠ›</option>
                    <option value="int">çŸ¥åŠ›</option>
                    <option value="mnd">ç²¾ç¥åŠ›</option>
                </select>
                <input type="text" class="buff-name" placeholder="ãƒãƒ•/ãƒ‡ãƒãƒ•å">
                <input type="number" class="buff-value" placeholder="å€¤">
                <input type="number" class="buff-duration" placeholder="R" min="1" title="æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰">
            </div>
            <div class="buff-item">
                <select class="buff-target"
                    style="padding: 2px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pdmg">ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="mdmg">é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="hit">å‘½ä¸­</option>
                    <option value="dodge">å›é¿</option>
                    <option value="vit">ç”Ÿå‘½åŠ›</option>
                    <option value="int">çŸ¥åŠ›</option>
                    <option value="mnd">ç²¾ç¥åŠ›</option>
                </select>
                <input type="text" class="buff-name" placeholder="ãƒãƒ•/ãƒ‡ãƒãƒ•å">
                <input type="number" class="buff-value" placeholder="å€¤">
                <input type="number" class="buff-duration" placeholder="R" min="1" title="æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰">
            </div>
            <div class="buff-item">
                <input type="checkbox" class="buff-active-chk" checked title="æœ‰åŠ¹/ç„¡åŠ¹"
                    style="margin-right: 5px; cursor: pointer; width: 14px; height: 14px;">
                <select class="buff-target"
                    style="padding: 2px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pdmg">ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="mdmg">é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸</option>
                    <option value="hit">å‘½ä¸­</option>
                    <option value="dodge">å›é¿</option>
                    <option value="vit">ç”Ÿå‘½åŠ›</option>
                    <option value="int">çŸ¥åŠ›</option>
                    <option value="mnd">ç²¾ç¥åŠ›</option>
                </select>
                <input type="text" class="buff-name" placeholder="ãƒãƒ•/ãƒ‡ãƒãƒ•å">
                <input type="number" class="buff-value" placeholder="å€¤">
                <input type="number" class="buff-duration" placeholder="R" min="1" title="æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰">
            </div>
        </div>

        <div id="evasion-container" style="width: 100%; margin-top: 20px; margin-bottom: 20px;">
            <div class="stats-label" style="font-size: 0.9rem; margin-bottom: 5px;">ğŸ›¡ï¸ å›é¿åŠ›ï¼ˆæ•æ·Bï¼‹æŠ€èƒ½ãƒ¬ãƒ™ãƒ«ï¼‹è£…å‚™ï¼‰</div>
            <div
                style="display: flex; align-items: center; gap: 8px; background-color: var(--surface-color); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                <!-- ãƒœã‚¿ãƒ³ -->
                <button type="button" id="roll-evasion-btn" class="calc-btn" title="å›é¿åˆ¤å®š"
                    style="font-size: 1.5rem; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--primary); cursor: pointer; background-color: transparent;">ğŸ²</button>

                <div style="display: flex; flex-wrap: wrap; gap: 10px; flex-grow: 1; align-items: center;">
                    <!-- æ•æ·B -->
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-size: 0.7rem; color: #94a3b8;">æ•æ·B</span>
                        <input type="number" id="evasion-agi-b" class="power-input"
                            style="width: 50px; background-color: var(--bg-color);" readonly value="0">
                    </div>
                    <span>ï¼‹</span>
                    <!-- æŠ€èƒ½ -->
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-size: 0.7rem; color: #94a3b8;">å›é¿æŠ€èƒ½</span>
                        <select id="evasion-skill-select" class="power-input"
                            style="width: 140px; padding: 4px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-color);">
                            <option value="0">ãªã— (0)</option>
                        </select>
                    </div>
                    <span>ï¼‹</span>
                    <!-- è£…å‚™è£œæ­£ -->
                    <div style="display: flex; flex-direction: column;">
                        <span style="font-size: 0.7rem; color: #94a3b8;">è£…å‚™ãƒ»ãã®ä»–</span>
                        <input type="number" id="evasion-equip" class="power-input" style="width: 60px;"
                            placeholder="0">
                    </div>
                    <span style="font-weight: bold; margin-left: auto;">ï¼</span>
                    <!-- åˆè¨ˆå›é¿åŠ› -->
                    <div
                        style="display: flex; flex-direction: column; align-items: center; background-color: var(--bg-color); padding: 5px 15px; border-radius: 4px; border: 1px solid var(--border-color);">
                        <span style="font-size: 0.7rem; color: #94a3b8;">å›é¿åŠ›åˆè¨ˆ</span>
                        <span id="evasion-total"
                            style="font-size: 1.5rem; font-weight: bold; color: var(--accent);">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="weapons-container" style="width: 100%; margin-top: 10px;">
            <!-- æ­¦å™¨ã‚»ãƒƒãƒˆ 1-4 -->
            <div class="accordion-item" id="weapon-set-1">
                <div class="accordion-header" onclick="toggleAccordion('weapon-set-1')">
                    æ­¦å™¨ 1 <span class="weapon-title-tag" id="weapon-1-tag" style="display: none;"></span>
                </div>
                <div class="accordion-content">
                    <div class="weapon-inputs-grid">
                        <div class="weapon-input-item">
                            <label class="weapon-label">åå‰</label>
                            <input type="text" id="weapon-1-name" class="power-input weapon-name-input"
                                style="width: 100%;" placeholder="åå‰" data-index="1">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ç”¨æ³•</label>
                            <input type="text" id="weapon-1-usage" class="power-input" style="width: 100%;"
                                placeholder="-">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">å¿…ç­‹</label>
                            <input type="number" id="weapon-1-reqd" class="power-input" style="width: 100%;"
                                placeholder="0">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-hit-label" id="weapon-1-hit-label" data-index="1"
                                style="color: var(--accent); font-weight: bold;">å‘½ä¸­åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-1-hit" class="power-input weapon-hit-input"
                                    placeholder="0" style="width: 100%;" data-index="1">
                                <button type="button" class="calc-btn weapon-hit-calc-btn" data-index="1"
                                    title="å‘½ä¸­åˆ¤å®š">ğŸ²</button>
                            </div>
                        </div>
                    </div>
                    <div class="weapon-inputs-grid-2" style="margin-bottom: 0; grid-template-columns: 2fr 1fr 1fr;">
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-power-label" id="weapon-1-power-label" data-index="1"
                                style="color: var(--accent); font-weight: bold;">å¨åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-1-power" class="power-input weapon-power-input" min="0"
                                    max="100" placeholder="-" style="width: 100%;" data-index="1">
                                <button type="button" class="calc-btn weapon-calc-btn" data-index="1"
                                    title="ãƒ€ãƒ¡ãƒ¼ã‚¸ç®—å‡º">ğŸ²</button>
                            </div>
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ï¼£å€¤</label>
                            <input type="number" id="weapon-1-crit" class="power-input" min="3" max="12" value="10"
                                style="width: 100%;">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">è¿½åŠ ï¼¤</label>
                            <input type="number" id="weapon-1-extra-dmg" class="power-input" placeholder="0"
                                style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item collapsed" id="weapon-set-2">
                <div class="accordion-header" onclick="toggleAccordion('weapon-set-2')">
                    æ­¦å™¨ 2 <span class="weapon-title-tag" id="weapon-2-tag" style="display: none;"></span>
                </div>
                <div class="accordion-content">
                    <div class="weapon-inputs-grid">
                        <div class="weapon-input-item">
                            <label class="weapon-label">åå‰</label>
                            <input type="text" id="weapon-2-name" class="power-input weapon-name-input"
                                style="width: 100%;" placeholder="åå‰" data-index="2">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ç”¨æ³•</label>
                            <input type="text" id="weapon-2-usage" class="power-input" style="width: 100%;"
                                placeholder="-">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">å¿…ç­‹</label>
                            <input type="number" id="weapon-2-reqd" class="power-input" style="width: 100%;"
                                placeholder="0">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-hit-label" id="weapon-2-hit-label" data-index="2"
                                style="color: var(--accent); font-weight: bold;">å‘½ä¸­åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-2-hit" class="power-input weapon-hit-input"
                                    placeholder="0" style="width: 100%;" data-index="2">
                                <button type="button" class="calc-btn weapon-hit-calc-btn" data-index="2"
                                    title="å‘½ä¸­åˆ¤å®š">ğŸ²</button>
                            </div>
                        </div>
                    </div>
                    <div class="weapon-inputs-grid-2" style="margin-bottom: 0; grid-template-columns: 2fr 1fr 1fr;">
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-power-label" id="weapon-2-power-label" data-index="2"
                                style="color: var(--accent); font-weight: bold;">å¨åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-2-power" class="power-input weapon-power-input" min="0"
                                    max="100" placeholder="-" style="width: 100%;" data-index="2">
                                <button type="button" class="calc-btn weapon-calc-btn" data-index="2"
                                    title="ãƒ€ãƒ¡ãƒ¼ã‚¸ç®—å‡º">ğŸ²</button>
                            </div>
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ï¼£å€¤</label>
                            <input type="number" id="weapon-2-crit" class="power-input" min="3" max="12" value="10"
                                style="width: 100%;">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">è¿½åŠ ï¼¤</label>
                            <input type="number" id="weapon-2-extra-dmg" class="power-input" placeholder="0"
                                style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item collapsed" id="weapon-set-3">
                <div class="accordion-header" onclick="toggleAccordion('weapon-set-3')">
                    æ­¦å™¨ 3 <span class="weapon-title-tag" id="weapon-3-tag" style="display: none;"></span>
                </div>
                <div class="accordion-content">
                    <div class="weapon-inputs-grid">
                        <div class="weapon-input-item">
                            <label class="weapon-label">åå‰</label>
                            <input type="text" id="weapon-3-name" class="power-input weapon-name-input"
                                style="width: 100%;" placeholder="åå‰" data-index="3">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ç”¨æ³•</label>
                            <input type="text" id="weapon-3-usage" class="power-input" style="width: 100%;"
                                placeholder="-">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">å¿…ç­‹</label>
                            <input type="number" id="weapon-3-reqd" class="power-input" style="width: 100%;"
                                placeholder="0">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-hit-label" id="weapon-3-hit-label" data-index="3"
                                style="color: var(--accent); font-weight: bold;">å‘½ä¸­åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-3-hit" class="power-input weapon-hit-input"
                                    placeholder="0" style="width: 100%;" data-index="3">
                                <button type="button" class="calc-btn weapon-hit-calc-btn" data-index="3"
                                    title="å‘½ä¸­åˆ¤å®š">ğŸ²</button>
                            </div>
                        </div>
                    </div>
                    <div class="weapon-inputs-grid-2" style="margin-bottom: 0; grid-template-columns: 2fr 1fr 1fr;">
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-power-label" id="weapon-3-power-label" data-index="3"
                                style="color: var(--accent); font-weight: bold;">å¨åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-3-power" class="power-input weapon-power-input" min="0"
                                    max="100" placeholder="-" style="width: 100%;" data-index="3">
                                <button type="button" class="calc-btn weapon-calc-btn" data-index="3"
                                    title="ãƒ€ãƒ¡ãƒ¼ã‚¸ç®—å‡º">ğŸ²</button>
                            </div>
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ï¼£å€¤</label>
                            <input type="number" id="weapon-3-crit" class="power-input" min="3" max="12" value="10"
                                style="width: 100%;">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">è¿½åŠ ï¼¤</label>
                            <input type="number" id="weapon-3-extra-dmg" class="power-input" placeholder="0"
                                style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item collapsed" id="weapon-set-4">
                <div class="accordion-header" onclick="toggleAccordion('weapon-set-4')">
                    æ­¦å™¨ 4 <span class="weapon-title-tag" id="weapon-4-tag" style="display: none;"></span>
                </div>
                <div class="accordion-content">
                    <div class="weapon-inputs-grid">
                        <div class="weapon-input-item">
                            <label class="weapon-label">åå‰</label>
                            <input type="text" id="weapon-4-name" class="power-input weapon-name-input"
                                style="width: 100%;" placeholder="åå‰" data-index="4">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ç”¨æ³•</label>
                            <input type="text" id="weapon-4-usage" class="power-input" style="width: 100%;"
                                placeholder="-">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">å¿…ç­‹</label>
                            <input type="number" id="weapon-4-reqd" class="power-input" style="width: 100%;"
                                placeholder="0">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-hit-label" id="weapon-4-hit-label" data-index="4"
                                style="color: var(--accent); font-weight: bold;">å‘½ä¸­åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-4-hit" class="power-input weapon-hit-input"
                                    placeholder="0" style="width: 100%;" data-index="4">
                                <button type="button" class="calc-btn weapon-hit-calc-btn" data-index="4"
                                    title="å‘½ä¸­åˆ¤å®š">ğŸ²</button>
                            </div>
                        </div>
                    </div>
                    <div class="weapon-inputs-grid-2" style="margin-bottom: 0; grid-template-columns: 2fr 1fr 1fr;">
                        <div class="weapon-input-item">
                            <label class="weapon-label weapon-power-label" id="weapon-4-power-label" data-index="4"
                                style="color: var(--accent); font-weight: bold;">å¨åŠ›</label>
                            <div class="power-input-wrapper">
                                <input type="number" id="weapon-4-power" class="power-input weapon-power-input" min="0"
                                    max="100" placeholder="-" style="width: 100%;" data-index="4">
                                <button type="button" class="calc-btn weapon-calc-btn" data-index="4"
                                    title="ãƒ€ãƒ¡ãƒ¼ã‚¸ç®—å‡º">ğŸ²</button>
                            </div>
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">ï¼£å€¤</label>
                            <input type="number" id="weapon-4-crit" class="power-input" min="3" max="12" value="10"
                                style="width: 100%;">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">è¿½åŠ ï¼¤</label>
                            <input type="number" id="weapon-4-extra-dmg" class="power-input" placeholder="0"
                                style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é­”æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="magic-container" style="width: 100%; margin-bottom: 10px;">
            <div class="accordion-item collapsed" id="magic-set">
                <div class="accordion-header" onclick="toggleAccordion('magic-set')">
                    é­”æ³•
                </div>
                <div class="accordion-content">
                    <div class="weapon-inputs-grid-2" style="margin-bottom: 0; grid-template-columns: 2fr 1fr 1fr 2fr;">
                        <div class="weapon-input-item">
                            <label class="weapon-label" id="magic-power-label"
                                style="color: #a855f7; font-weight: bold; cursor: pointer;">é­”æ³•å¨åŠ›</label>
                            <div class="power-input-wrapper">
                                <button type="button" id="magic-cast-btn" class="calc-btn" title="é­”æ³•è¡Œä½¿åˆ¤å®š"
                                    style="background-color: var(--button-bg); color: var(--text-color);">ğŸ²</button>
                                <input type="number" id="magic-power-input" class="power-input" min="0" max="100"
                                    placeholder="-" style="width: 100%;">
                                <button type="button" id="magic-calc-btn" class="calc-btn" title="é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸ç®—å‡º">ğŸ²</button>
                            </div>
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label" style="display: flex; align-items: center; gap: 5px;">
                                é­”æ³•ï¼£å€¤
                                <label
                                    style="font-size: 0.7rem; font-weight: normal; color: var(--text-color); cursor: pointer; display: flex; align-items: center; gap: 2px;">
                                    <input type="checkbox" id="magic-no-crit"
                                        style="width: 12px; height: 12px; margin: 0;">
                                    ã‚¯ãƒªãªã—
                                </label>
                            </label>
                            <input type="number" id="magic-crit-input" class="power-input" min="3" max="12" value="10"
                                style="width: 100%;">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">é­”åŠ›</label>
                            <input type="number" id="magic-bonus-input" class="power-input" placeholder="0"
                                style="width: 100%;">
                        </div>
                        <div class="weapon-input-item">
                            <label class="weapon-label">é­”åŠ›ç¨®åˆ¥</label>
                            <select id="magic-type-select" class="power-input"
                                style="width: 100%; height: 38px; padding: 5px;">
                                <option value="">(æ‰‹å‹•å…¥åŠ›)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="rating-table-container" class="rating-table-wrapper">
            <!-- Table generated by JS -->
        </div>

        <div class="history">
            <h3 style="margin-top: 0; color: var(--text-color); font-size: 1rem;">å±¥æ­´</h3>
            <div id="history-container"></div>
        </div>
    </div>

    <script src="damage_table.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const decreaseBtn = document.getElementById('decrease-btn');
            const increaseBtn = document.getElementById('increase-btn');
            const diceCountDisplay = document.getElementById('dice-count');
            const rollBtn = document.getElementById('roll-btn');
            const diceContainer = document.getElementById('dice-container');
            const totalScoreDisplay = document.getElementById('total-score');
            const historyContainer = document.getElementById('history-container');
            const jsonUpload = document.getElementById('json-upload');
            const ratingTableContainer = document.getElementById('rating-table-container');
            const fateBtn = document.getElementById('fate-btn');
            const pcNameInput = document.getElementById('pc-name');
            const webhookUrlInput = document.getElementById('webhook-url');
            const webhookEnableCheckbox = document.getElementById('webhook-enable');
            const webhookStatus = document.getElementById('webhook-status');

            // å›é¿åˆ¤å®šç”¨è¦ç´ 
            const evasionAgiB = document.getElementById('evasion-agi-b');
            const evasionSkillSelect = document.getElementById('evasion-skill-select');
            const evasionEquip = document.getElementById('evasion-equip');
            const evasionTotal = document.getElementById('evasion-total');
            const bonusAgi = document.getElementById('bonus-agi');
            const rollEvasionBtn = document.getElementById('roll-evasion-btn');

            // ãƒãƒ•é›†è¨ˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            function calculateTotalBuff(targetType = 'all') {
                const buffItems = document.querySelectorAll('.buff-item');
                let total = 0;
                buffItems.forEach(item => {
                    const chk = item.querySelector('.buff-active-chk');
                    if (chk && !chk.checked) return; // ãƒã‚§ãƒƒã‚¯OFFãªã‚‰ç„¡è¦–

                    const tSelect = item.querySelector('.buff-target');
                    const vInput = item.querySelector('.buff-value');
                    const tVal = tSelect ? tSelect.value : 'all';
                    const val = parseInt(vInput ? vInput.value : 0, 10);
                    if (!isNaN(val) && (tVal === 'all' || tVal === targetType)) {
                        total += val;
                    }
                });
                return total;
            }

            // ãƒãƒ•ãƒ†ã‚­ã‚¹ãƒˆå–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆDiscordå—ä¿¡ç”¨ï¼‰
            function getActiveBuffTexts(targetType = 'all') {
                const buffItems = document.querySelectorAll('.buff-item');
                let activeBuffs = [];
                buffItems.forEach(item => {
                    const chk = item.querySelector('.buff-active-chk');
                    if (chk && !chk.checked) return; // ãƒã‚§ãƒƒã‚¯OFFãªã‚‰ç„¡è¦–

                    const tSelect = item.querySelector('.buff-target');
                    const nameInput = item.querySelector('.buff-name');
                    const vInput = item.querySelector('.buff-value');
                    const durInput = item.querySelector('.buff-duration');
                    const tVal = tSelect ? tSelect.value : 'all';

                    if (tVal === 'all' || tVal === targetType) {
                        const name = nameInput ? nameInput.value : '';
                        const val = vInput ? vInput.value : '';
                        const dur = durInput ? durInput.value : '';
                        if (name && val) {
                            activeBuffs.push(`${name}(${val > 0 ? '+' : ''}${val}) [æ®‹${dur}R]`);
                        }
                    }
                });
                return activeBuffs;
            }

            function updateEvasionTotal() {
                const agiB = parseInt(bonusAgi.value, 10) || 0;
                const skillLv = evasionSkillSelect ? parseInt(evasionSkillSelect.value, 10) || 0 : 0;
                const equip = parseInt(evasionEquip.value, 10) || 0;
                const buff = calculateTotalBuff('dodge');
                if (evasionAgiB) evasionAgiB.value = agiB;
                if (evasionTotal) evasionTotal.textContent = agiB + skillLv + equip + buff;
            }

            window.populateEvasionSkillSelect = function () {
                if (!evasionSkillSelect) return;
                const selectedOpt = evasionSkillSelect.options[evasionSkillSelect.selectedIndex];
                const currentText = selectedOpt && selectedOpt.dataset ? selectedOpt.dataset.name : '';

                evasionSkillSelect.innerHTML = '<option value="0" data-name="ãªã—">ãªã— (0)</option>';
                for (let i = 1; i <= 5; i++) {
                    const nameEl = document.getElementById(`skill-name-${i}`);
                    const lvEl = document.getElementById(`skill-lv-${i}`);
                    const sName = nameEl ? nameEl.value : '';
                    const sLv = lvEl ? lvEl.value : '';
                    if (sName) {
                        const option = document.createElement('option');
                        option.value = sLv || 0;
                        option.dataset.name = sName;
                        option.textContent = `${sName} (${sLv || 0})`;
                        evasionSkillSelect.appendChild(option);
                    }
                }

                // é¸æŠçŠ¶æ…‹ã®å¾©å…ƒ
                if (currentText && currentText !== 'ãªã—') {
                    for (let i = 0; i < evasionSkillSelect.options.length; i++) {
                        if (evasionSkillSelect.options[i].dataset.name === currentText) {
                            evasionSkillSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                updateEvasionTotal();
            };

            // æŠ€èƒ½ãƒ»æ•æ·Bãƒ»è£…å‚™ã®å¤‰æ›´æ¤œçŸ¥ã€ãŠã‚ˆã³ãƒãƒ•ã®å¤‰æ›´æ™‚ã«ã‚‚å›é¿åˆ¤å®šã®å†è¨ˆç®—ã‚’è¡Œã†
            if (bonusAgi && evasionEquip && evasionSkillSelect) {
                [bonusAgi, evasionEquip].forEach(el => {
                    el.addEventListener('input', updateEvasionTotal);
                    el.addEventListener('change', updateEvasionTotal);
                });
                evasionSkillSelect.addEventListener('change', updateEvasionTotal);
            }
            document.querySelectorAll('.buff-target, .buff-value').forEach(el => {
                el.addEventListener('input', updateEvasionTotal);
                el.addEventListener('change', updateEvasionTotal);
            });

            for (let i = 1; i <= 5; i++) {
                const sNameEl = document.getElementById(`skill-name-${i}`);
                const sLvEl = document.getElementById(`skill-lv-${i}`);
                if (sNameEl) {
                    sNameEl.addEventListener('input', window.populateEvasionSkillSelect);
                    sNameEl.addEventListener('change', window.populateEvasionSkillSelect);
                }
                if (sLvEl) {
                    sLvEl.addEventListener('input', window.populateEvasionSkillSelect);
                    sLvEl.addEventListener('change', window.populateEvasionSkillSelect);
                }
            }

            if (rollEvasionBtn) {
                rollEvasionBtn.addEventListener('click', () => {
                    const selectedOpt = evasionSkillSelect ? evasionSkillSelect.options[evasionSkillSelect.selectedIndex] : null;
                    const sName = (selectedOpt && selectedOpt.dataset) ? (selectedOpt.dataset.name || 'å›é¿') : 'å›é¿';
                    const agiB = parseInt(bonusAgi.value, 10) || 0;
                    const skillLv = evasionSkillSelect ? parseInt(evasionSkillSelect.value, 10) || 0 : 0;
                    const equip = parseInt(evasionEquip.value, 10) || 0;
                    const baseEvasion = agiB + skillLv + equip;
                    rollCheck('å›é¿', sName, baseEvasion);
                });
            }

            // åˆæœŸè¡¨ç¤ºã§å›é¿ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
            if (typeof window.populateEvasionSkillSelect === 'function') {
                window.populateEvasionSkillSelect();
            }

            let lastRollData = null;

            // è¨­å®šã®èª­ã¿è¾¼ã¿
            pcNameInput.value = localStorage.getItem('sw25_pc_name') || '';
            webhookUrlInput.value = localStorage.getItem('sw25_webhook_url') || '';
            webhookEnableCheckbox.checked = localStorage.getItem('sw25_webhook_enable') === 'true';

            // è¨­å®šã®ä¿å­˜
            const saveSettings = () => {
                localStorage.setItem('sw25_pc_name', pcNameInput.value);
                localStorage.setItem('sw25_webhook_url', webhookUrlInput.value);
                localStorage.setItem('sw25_webhook_enable', webhookEnableCheckbox.checked);
            };

            pcNameInput.addEventListener('change', saveSettings);
            webhookUrlInput.addEventListener('change', saveSettings);
            webhookEnableCheckbox.addEventListener('change', saveSettings);

            // Discordé€ä¿¡é–¢æ•°
            async function sendToDiscord(rollData) {
                if (!webhookEnableCheckbox.checked || !webhookUrlInput.value) return;

                const pcName = pcNameInput.value || 'å†’é™ºè€…';
                const round = roundDisplay.textContent;

                // ãƒãƒ•æƒ…å ±ã®å–å¾—
                // ãƒãƒ•æƒ…å ±ã®å–å¾—
                const activeBuffs = getActiveBuffTexts(rollData.targetType || 'all');

                const content = {
                    username: pcName,
                    embeds: [{
                        title: rollData.isFate ? `ã€é‹å‘½å¤‰è»¢ã€‘ ${rollData.title}` : rollData.title,
                        description: `**çµæœ: ${rollData.displayTotal}**\n${rollData.historyRolls}`,
                        color: rollData.isFate ? 0x10b981 : (rollData.isAutoFail ? 0xef4444 : 0x6366f1),
                        fields: [
                            { name: "ãƒ©ã‚¦ãƒ³ãƒ‰", value: `${round}R`, inline: true }
                        ],
                        footer: { text: "SW2.5 ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ©ãƒ¼" },
                        timestamp: new Date().toISOString()
                    }]
                };

                if (activeBuffs.length > 0) {
                    content.embeds[0].fields.push({ name: "é©ç”¨ä¸­ã®ãƒãƒ•", value: activeBuffs.join('\n'), inline: false });
                }

                try {
                    const response = await fetch(webhookUrlInput.value, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(content)
                    });
                    if (response.ok) {
                        webhookStatus.textContent = 'é€ä¿¡å®Œäº†';
                        webhookStatus.style.color = '#10b981';
                    } else {
                        webhookStatus.textContent = 'é€ä¿¡å¤±æ•—';
                        webhookStatus.style.color = '#ef4444';
                    }
                } catch (err) {
                    webhookStatus.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
                    webhookStatus.style.color = '#ef4444';
                }
                setTimeout(() => { webhookStatus.textContent = ''; }, 3000);
            }

            // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰åˆ¶å¾¡
            window.toggleAccordion = function (id) {
                const item = document.getElementById(id);
                const isCollapsed = item.classList.contains('collapsed');

                // æ­¦å™¨ã‚»ãƒƒãƒˆã®å ´åˆã¯ä»–ã®æ­¦å™¨ã‚»ãƒƒãƒˆã‚’é–‰ã˜ã‚‹ï¼ˆä»»æ„ã€‚ä»Šå›ã¯å€‹åˆ¥ã«é–‹é–‰å¯èƒ½ã¨ã™ã‚‹ï¼‰
                // item.classList.toggle('collapsed');

                if (isCollapsed) {
                    item.classList.remove('collapsed');
                } else {
                    item.classList.add('collapsed');
                }
            };

            // æŠ€èƒ½ãƒãƒƒãƒ”ãƒ³ã‚°
            const skillMap = {
                'Fig': 'ãƒ•ã‚¡ã‚¤ã‚¿ãƒ¼', 'Gra': 'ã‚°ãƒ©ãƒƒãƒ—ãƒ©ãƒ¼', 'Fen': 'ãƒ•ã‚§ãƒ³ã‚µãƒ¼', 'Sho': 'ã‚·ãƒ¥ãƒ¼ã‚¿ãƒ¼',
                'Sor': 'ã‚½ãƒ¼ã‚µãƒ©ãƒ¼', 'Con': 'ã‚³ãƒ³ã‚¸ãƒ£ãƒ©ãƒ¼', 'Pri': 'ãƒ—ãƒªãƒ¼ã‚¹ãƒˆ', 'Mag': 'ãƒã‚®ãƒ†ãƒƒã‚¯',
                'Fai': 'ãƒ•ã‚§ã‚¢ãƒªãƒ¼ãƒ†ã‚¤ãƒãƒ¼', 'Dru': 'ãƒ‰ãƒ«ã‚¤ãƒ‰', 'Dem': 'ãƒ‡ãƒ¼ãƒ¢ãƒ³ãƒ«ãƒ¼ãƒ©ãƒ¼', 'Sco': 'ã‚¹ã‚«ã‚¦ãƒˆ',
                'Ran': 'ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼', 'Sag': 'ã‚»ãƒ¼ã‚¸', 'Rid': 'ãƒ©ã‚¤ãƒ€ãƒ¼', 'Alc': 'ã‚¢ãƒ«ã‚±ãƒŸã‚¹ãƒˆ',
                'Bar': 'ãƒãƒ¼ãƒ‰', 'War': 'ã‚¦ã‚©ãƒ¼ãƒªãƒ¼ãƒ€ãƒ¼', 'Mys': 'ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯', 'Art': 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¶ãƒ³',
                'Ari': 'ã‚¢ãƒªã‚¹ãƒˆã‚¯ãƒ©ã‚·ãƒ¼', 'Sch': 'ã‚¹ã‚«ãƒ©ãƒ¼', 'Bib': 'ãƒ“ãƒ–ãƒªã‚ªãƒãƒ³ã‚µãƒ¼', 'Dar': 'ãƒ€ãƒ¼ã‚¯ãƒãƒ³ã‚¿ãƒ¼',
                'Abys': 'ã‚¢ãƒ“ã‚¹ã‚²ã‚¤ã‚¶ãƒ¼', 'Aby': 'ã‚¢ãƒ“ã‚¹ã‚²ã‚¤ã‚¶ãƒ¼', 'Sha': 'ã‚·ãƒ£ãƒ‰ã‚¦ã‚¦ã‚£ãƒƒãƒ', 'Phy': 'ãƒ•ã‚£ã‚¸ã‚«ãƒ«ãƒã‚¹ã‚¿ãƒ¼',
                'Gri': 'ã‚°ãƒªãƒ¢ãƒ¯ãƒ¼ãƒ«', 'Enh': 'ã‚¨ãƒ³ãƒãƒ³ã‚µãƒ¼', 'Neu': 'ã‚·ãƒ¥ãƒ¼ã‚¿ãƒ¼', 'Bat': 'ãƒãƒˆãƒ«ãƒ€ãƒ³ã‚µãƒ¼', 'Geo': 'ã‚¸ã‚ªãƒãƒ³ã‚µãƒ¼'
            };

            // é™¤å¤–ã™ã¹ãã‚·ã‚¹ãƒ†ãƒ é …ç›®
            const excludeList = ['lvCaster', 'lvCommon', 'lvMagic'];

            // JSON èª­ã¿è¾¼ã¿æ©Ÿèƒ½
            jsonUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // èª­ã¿è¾¼ã¿å‰ã«å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
                const fieldsToReset = [
                    'stt-dex', 'bonus-dex', 'stt-agi', 'bonus-agi', 'stt-str', 'bonus-str',
                    'stt-vit', 'bonus-vit', 'stt-int', 'bonus-int', 'stt-mnd', 'bonus-mnd'
                ];
                fieldsToReset.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });

                for (let i = 1; i <= 5; i++) {
                    const nameEl = document.getElementById(`skill-name-${i}`);
                    const lvEl = document.getElementById(`skill-lv-${i}`);
                    if (nameEl) nameEl.value = '';
                    if (lvEl) lvEl.value = '';
                }

                const weaponFields = ['magic-power-input', 'magic-crit-input', 'magic-bonus-input'];
                // æ­¦å™¨1-4ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
                for (let i = 1; i <= 4; i++) {
                    ['name', 'usage', 'reqd', 'hit', 'power', 'crit', 'extra-dmg'].forEach(suffix => {
                        const el = document.getElementById(`weapon-${i}-${suffix}`);
                        if (el) {
                            if (suffix === 'crit') el.value = '10';
                            else el.value = '';
                        }
                    });
                    const tag = document.getElementById(`weapon-${i}-tag`);
                    if (tag) {
                        tag.style.display = 'none';
                        tag.textContent = '';
                    }
                }
                weaponFields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        if (id.includes('crit')) el.value = '10';
                        else el.value = '';
                    }
                });
                const magicSelect = document.getElementById('magic-type-select');
                if (magicSelect) magicSelect.innerHTML = '<option value="">(æ‰‹å‹•å…¥åŠ›)</option>';
                const magicNoCrit = document.getElementById('magic-no-crit');
                if (magicNoCrit) magicNoCrit.checked = false;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã®å¾©å…ƒ
                        const pcNameInput = document.getElementById('pc-name');
                        if (pcNameInput && (data.characterName !== undefined || data.pcName !== undefined)) {
                            pcNameInput.value = data.characterName || data.pcName || '';
                            // localStorageã¸ã®ä¿å­˜ã‚’ãƒˆãƒªã‚¬ãƒ¼
                            pcNameInput.dispatchEvent(new Event('change'));
                        }

                        // èƒ½åŠ›å€¤ã¨ãƒœãƒ¼ãƒŠã‚¹ã®å…¥åŠ›
                        if (data.sttDex) document.getElementById('stt-dex').value = data.sttDex;
                        if (data.bonusDex) document.getElementById('bonus-dex').value = data.bonusDex;
                        if (data.sttAgi) document.getElementById('stt-agi').value = data.sttAgi;
                        if (data.bonusAgi) document.getElementById('bonus-agi').value = data.bonusAgi;
                        if (data.sttStr) document.getElementById('stt-str').value = data.sttStr;
                        if (data.bonusStr) document.getElementById('bonus-str').value = data.bonusStr;
                        if (data.sttVit) document.getElementById('stt-vit').value = data.sttVit;
                        if (data.bonusVit) document.getElementById('bonus-vit').value = data.bonusVit;
                        if (data.sttInt) document.getElementById('stt-int').value = data.sttInt;
                        if (data.bonusInt) document.getElementById('bonus-int').value = data.bonusInt;
                        if (data.sttMnd) document.getElementById('stt-mnd').value = data.sttMnd;
                        if (data.bonusMnd) document.getElementById('bonus-mnd').value = data.bonusMnd;

                        // æ­¦å™¨ãƒ‡ãƒ¼ã‚¿ã®å…¥åŠ› (1ã€œ4)
                        for (let i = 1; i <= 4; i++) {
                            const wName = data[`weapon${i}Name`];
                            if (wName) {
                                document.getElementById(`weapon-${i}-name`).value = wName;
                                document.getElementById(`weapon-${i}-usage`).value = data[`weapon${i}Usage`] || '';
                                document.getElementById(`weapon-${i}-reqd`).value = data[`weapon${i}Reqd`] || '';
                                document.getElementById(`weapon-${i}-hit`).value = data[`weapon${i}AccTotal`] || '';
                                document.getElementById(`weapon-${i}-power`).value = data[`weapon${i}Rate`] || '';
                                document.getElementById(`weapon-${i}-crit`).value = data[`weapon${i}Crit`] || '10';
                                document.getElementById(`weapon-${i}-extra-dmg`).value = data[`weapon${i}DmgTotal`] || '';

                                // ãƒ˜ãƒƒãƒ€ãƒ¼ã«åå‰ã‚’è¡¨ç¤º
                                const tag = document.getElementById(`weapon-${i}-tag`);
                                if (tag) {
                                    tag.textContent = wName;
                                    tag.style.display = 'inline-block';
                                }
                                // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯é–‹ãï¼ˆ1ã¤ç›®ã®ã¿ã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‚‚ã®ã™ã¹ã¦ï¼‰
                                if (i === 1) document.getElementById(`weapon-set-${i}`).classList.remove('collapsed');
                            }
                        }

                        // å…¨ã¦ã®é­”åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºã—ã¦ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
                        const magicSelect = document.getElementById('magic-type-select');
                        const magicBonusInput = document.getElementById('magic-bonus-input');
                        const allMagicData = {};

                        // ãƒãƒ•ãƒ»ãƒ‡ãƒãƒ•ã®å¾©å…ƒ
                        if (data.buffs && Array.isArray(data.buffs)) {
                            const buffItems = document.querySelectorAll('.buff-item');
                            buffItems.forEach((item, index) => {
                                if (data.buffs[index]) {
                                    const bData = data.buffs[index];
                                    const tSelect = item.querySelector('.buff-target');
                                    const nameInput = item.querySelector('.buff-name');
                                    const vInput = item.querySelector('.buff-value');
                                    const durInput = item.querySelector('.buff-duration');
                                    const chk = item.querySelector('.buff-active-chk');

                                    if (tSelect) tSelect.value = bData.target || 'all';
                                    if (nameInput) nameInput.value = bData.name || '';
                                    if (vInput) vInput.value = bData.value || '';
                                    if (durInput) durInput.value = bData.duration || '';

                                    if (chk) {
                                        chk.checked = (bData.active !== false); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆtrue
                                        if (chk.checked) {
                                            item.style.opacity = '1';
                                        } else {
                                            item.style.opacity = '0.5';
                                        }
                                    }
                                }
                            });
                        }

                        for (let key in data) {
                            if (key.startsWith('magicPower') && data[key] > 0) {
                                const skillKey = key.substring(10);
                                const skillName = skillMap[skillKey] || skillKey;
                                allMagicData[skillName] = data[key];

                                const option = document.createElement('option');
                                option.value = data[key];
                                option.textContent = `${skillName} (${data[key]})`;
                                magicSelect.appendChild(option);
                            }
                        }

                        // é­”åŠ›ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€æœ€åˆã®ã‚‚ã®ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚»ãƒƒãƒˆ
                        const magicEntries = Object.entries(allMagicData);
                        if (magicEntries.length > 0) {
                            magicSelect.value = magicEntries[0][1];
                            magicBonusInput.value = magicEntries[0][1];
                        }

                        // å€‹åˆ¥ã®æ‰‹å…¥åŠ›é­”æ³•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¾©å…ƒ
                        if (data.magicPowerInput !== undefined) document.getElementById('magic-power-input').value = data.magicPowerInput;
                        if (data.magicCritInput !== undefined) document.getElementById('magic-crit-input').value = data.magicCritInput;
                        if (data.magicBonusInput !== undefined) document.getElementById('magic-bonus-input').value = data.magicBonusInput;
                        if (data.magicNoCrit !== undefined) document.getElementById('magic-no-crit').checked = data.magicNoCrit;

                        // å›é¿ã®è£…å‚™è£œæ­£
                        if (data.evasionEquip !== undefined) {
                            const evEquip = document.getElementById('evasion-equip');
                            if (evEquip) evEquip.value = data.evasionEquip;
                        }

                        magicSelect.addEventListener('change', (e) => {
                            if (e.target.value !== '') {
                                magicBonusInput.value = e.target.value;
                            }
                        });


                        // æŠ€èƒ½ã®å…¥åŠ›
                        let foundSkills = [];
                        for (let key in data) {
                            if (key.startsWith('lv') && data[key] > 0 && !excludeList.includes(key)) {
                                const skillKey = key.substring(2);
                                const skillName = skillMap[skillKey];
                                // ãƒãƒƒãƒ”ãƒ³ã‚°ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
                                if (skillName) {
                                    foundSkills.push({ name: skillName, level: data[key] });
                                }
                            }
                        }
                        // æ‰‹å‹•å…¥åŠ›ã®ç‹¬è‡ªä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚å¾©å…ƒå¯¾è±¡ã«è¿½åŠ 
                        for (let i = 1; i <= 5; i++) {
                            if (data[`customSkill${i}Name`] && data[`customSkill${i}Lv`]) {
                                foundSkills.push({ name: data[`customSkill${i}Name`], level: data[`customSkill${i}Lv`] });
                            }
                        }

                        // ãƒ¬ãƒ™ãƒ«é †ã«ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
                        foundSkills.sort((a, b) => b.level - a.level);

                        // ä¸Šä½5ã¤ã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
                        for (let i = 0; i < 5; i++) {
                            const nameInput = document.getElementById(`skill-name-${i + 1}`);
                            const lvInput = document.getElementById(`skill-lv-${i + 1}`);
                            if (foundSkills[i]) {
                                nameInput.value = foundSkills[i].name;
                                lvInput.value = foundSkills[i].level;
                            } else {
                                nameInput.value = '';
                                lvInput.value = '';
                            }
                        }

                        // å›é¿ã‚¹ã‚­ãƒ«ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ã—ã€ä¿å­˜ã•ã‚Œã¦ã„ãŸåå‰ã‚’é¸æŠ
                        if (typeof window.populateEvasionSkillSelect === 'function') {
                            window.populateEvasionSkillSelect();
                            const evSelect = document.getElementById('evasion-skill-select');
                            if (evSelect && data.evasionSkillName) {
                                for (let i = 0; i < evSelect.options.length; i++) {
                                    if (evSelect.options[i].dataset.name === data.evasionSkillName) {
                                        evSelect.selectedIndex = i;
                                        break;
                                    }
                                }
                                const event = new Event('change');
                                evSelect.dispatchEvent(event);
                            }
                        }

                        alert('ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                    } catch (error) {
                        console.error('JSON parse error:', error);
                        alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                };
                reader.readAsText(file);
            });

            // ç¾åœ¨ã®çŠ¶æ…‹ã‚’JSONã§ä¿å­˜
            const jsonDownloadBtn = document.getElementById('json-download');
            if (jsonDownloadBtn) {
                jsonDownloadBtn.addEventListener('click', () => {
                    const data = {};

                    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å
                    const pcNameInputSafe = document.getElementById('pc-name');
                    data.characterName = pcNameInputSafe ? pcNameInputSafe.value : '';

                    // èƒ½åŠ›å€¤ã¨ãƒœãƒ¼ãƒŠã‚¹
                    data.sttDex = document.getElementById('stt-dex').value;
                    data.bonusDex = document.getElementById('bonus-dex').value;
                    data.sttAgi = document.getElementById('stt-agi').value;
                    data.bonusAgi = document.getElementById('bonus-agi').value;
                    data.sttStr = document.getElementById('stt-str').value;
                    data.bonusStr = document.getElementById('bonus-str').value;
                    data.sttVit = document.getElementById('stt-vit').value;
                    data.bonusVit = document.getElementById('bonus-vit').value;
                    data.sttInt = document.getElementById('stt-int').value;
                    data.bonusInt = document.getElementById('bonus-int').value;
                    data.sttMnd = document.getElementById('stt-mnd').value;
                    data.bonusMnd = document.getElementById('bonus-mnd').value;

                    // æ­¦å™¨ãƒ‡ãƒ¼ã‚¿
                    for (let i = 1; i <= 4; i++) {
                        const wName = document.getElementById(`weapon-${i}-name`).value;
                        if (wName) {
                            data[`weapon${i}Name`] = wName;
                            data[`weapon${i}Usage`] = document.getElementById(`weapon-${i}-usage`).value;
                            data[`weapon${i}Reqd`] = document.getElementById(`weapon-${i}-reqd`).value;
                            data[`weapon${i}AccTotal`] = document.getElementById(`weapon-${i}-hit`).value;
                            data[`weapon${i}Rate`] = document.getElementById(`weapon-${i}-power`).value;
                            data[`weapon${i}Crit`] = document.getElementById(`weapon-${i}-crit`).value;
                            data[`weapon${i}DmgTotal`] = document.getElementById(`weapon-${i}-extra-dmg`).value;
                        }
                    }

                    // ãƒãƒ•ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
                    const buffItems = document.querySelectorAll('.buff-item');
                    data.buffs = [];
                    buffItems.forEach(item => {
                        const tSelect = item.querySelector('.buff-target');
                        const nameInput = item.querySelector('.buff-name');
                        const vInput = item.querySelector('.buff-value');
                        const durInput = item.querySelector('.buff-duration');
                        const chk = item.querySelector('.buff-active-chk');

                        data.buffs.push({
                            target: tSelect ? tSelect.value : 'all',
                            name: nameInput ? nameInput.value : '',
                            value: vInput ? vInput.value : '',
                            duration: durInput ? durInput.value : '',
                            active: chk ? chk.checked : true
                        });
                    });

                    // é­”æ³•ã®å€‹åˆ¥å…¥åŠ›ãƒ‡ãƒ¼ã‚¿
                    const mPowerInputSafe = document.getElementById('magic-power-input');
                    const mCritInputSafe = document.getElementById('magic-crit-input');
                    const mBonusInputSafe = document.getElementById('magic-bonus-input');
                    const mNoCritSafe = document.getElementById('magic-no-crit');

                    data.magicPowerInput = mPowerInputSafe ? mPowerInputSafe.value : '';
                    data.magicCritInput = mCritInputSafe ? mCritInputSafe.value : '10';
                    data.magicBonusInput = mBonusInputSafe ? mBonusInputSafe.value : '';
                    data.magicNoCrit = mNoCritSafe ? mNoCritSafe.checked : false;

                    // å›é¿ãƒ‡ãƒ¼ã‚¿
                    const evSelect = document.getElementById('evasion-skill-select');
                    data.evasionSkillName = (evSelect && evSelect.selectedIndex > 0) ? evSelect.options[evSelect.selectedIndex].dataset.name : '';
                    const evasionEquipSafe = document.getElementById('evasion-equip');
                    data.evasionEquip = evasionEquipSafe ? evasionEquipSafe.value : '';

                    // æŠ€èƒ½ãƒ‡ãƒ¼ã‚¿
                    // skillMapã®é€†é †è¾æ›¸ã‚’ä½œæˆã—ã€å®šç¾©æ¸ˆã¿ã®ã‚­ãƒ¼ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
                    const reverseSkillMap = {};
                    for (let key in skillMap) {
                        reverseSkillMap[skillMap[key]] = key;
                    }

                    for (let i = 1; i <= 5; i++) {
                        const sName = document.getElementById(`skill-name-${i}`).value;
                        const sLv = document.getElementById(`skill-lv-${i}`).value;
                        if (sName && sLv !== '') {
                            const originalKey = reverseSkillMap[sName];
                            if (originalKey) {
                                data[`lv${originalKey}`] = parseInt(sLv, 10);
                            } else {
                                // ç‹¬è‡ªæŠ€èƒ½ã‚„æ‰‹å…¥åŠ›ã®å ´åˆã¯ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ã§ä¿å­˜
                                data[`customSkill${i}Name`] = sName;
                                data[`customSkill${i}Lv`] = parseInt(sLv, 10);
                            }
                        }
                    }

                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${document.getElementById('pc-name').value || 'character'}_data.json`;
                    document.body.appendChild(a);
                    a.click();

                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 0);
                });
            }

            const roundDecreaseBtn = document.getElementById('round-decrease');
            const roundIncreaseBtn = document.getElementById('round-increase');
            const roundDisplay = document.getElementById('round-display');
            let roundCount = 1;

            roundDecreaseBtn.addEventListener('click', () => {
                if (roundCount > 1) {
                    roundCount--;
                    roundDisplay.textContent = roundCount;
                    roundDecreaseBtn.disabled = roundCount <= 1;
                }
            });

            roundIncreaseBtn.addEventListener('click', () => {
                roundCount++;
                roundDisplay.textContent = roundCount;
                roundDecreaseBtn.disabled = roundCount <= 1;

                // ãƒãƒ•ãƒ»ãƒ‡ãƒãƒ•ã®æŒç¶šãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æ¸›ç®—å‡¦ç†
                const buffItems = document.querySelectorAll('.buff-item');
                buffItems.forEach(item => {
                    const durationInput = item.querySelector('.buff-duration');
                    const chk = item.querySelector('.buff-active-chk');

                    if (durationInput && durationInput.value !== '' && chk && chk.checked) {
                        let duration = parseInt(durationInput.value, 10);
                        if (!isNaN(duration) && duration > 0) {
                            duration--;
                            durationInput.value = duration;

                            if (duration <= 0) {
                                // åŠ¹æœåˆ‡ã‚Œï¼šãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆ
                                chk.checked = false;
                                item.style.opacity = '0.5';
                            }
                        }
                    }
                });
            });
            roundDecreaseBtn.disabled = true; // åˆå›ã¯1ãƒ©ã‚¦ãƒ³ãƒ‰ãªã®ã§ãƒã‚¤ãƒŠã‚¹ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–

            // ãƒãƒ•ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.buff-active-chk').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    const buffItem = e.target.closest('.buff-item');
                    if (buffItem) {
                        buffItem.style.opacity = e.target.checked ? '1' : '0.5';
                    }
                });
            });

            let diceCount = 2; // Default to 2d6
            const MAX_DICE = 10;
            const MIN_DICE = 1;

            // Initialize display
            updateDiceCountDisplay();

            decreaseBtn.addEventListener('click', () => {
                if (diceCount > MIN_DICE) {
                    diceCount--;
                    updateDiceCountDisplay();
                }
            });

            increaseBtn.addEventListener('click', () => {
                if (diceCount < MAX_DICE) {
                    diceCount++;
                    updateDiceCountDisplay();
                }
            });

            function updateDiceCountDisplay(type = 'weapon', weaponIdx = '1') {
                diceCountDisplay.textContent = `${diceCount}d6`;
                decreaseBtn.disabled = diceCount <= MIN_DICE;
                increaseBtn.disabled = diceCount >= MAX_DICE;

                if (diceCount === 2) {
                    updateRatingTable(type, weaponIdx);
                } else {
                    ratingTableContainer.className = 'rating-table-wrapper';
                }
            }

            // æ­¦å™¨åã®å…¥åŠ›ç›£è¦–
            document.querySelectorAll('.weapon-name-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = e.target.getAttribute('data-index');
                    const tag = document.getElementById(`weapon-${idx}-tag`);
                    if (tag) {
                        tag.textContent = e.target.value;
                        tag.style.display = e.target.value ? 'inline-block' : 'none';
                    }
                });
            });

            // å¨åŠ›å…¥åŠ›ã®ç›£è¦–
            document.querySelectorAll('.weapon-power-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const idx = e.target.getAttribute('data-index');
                    updateRatingTable('weapon', idx);
                });
            });

            const magicPowerInput = document.getElementById('magic-power-input');
            if (magicPowerInput) {
                magicPowerInput.addEventListener('input', () => updateRatingTable('magic'));
            }

            function updateRatingTable(typeOrIndexedType = 'weapon', weaponIdx = '1') {
                if (diceCount !== 2 || typeof damageTable === 'undefined') {
                    ratingTableContainer.className = 'rating-table-wrapper';
                    return;
                }

                let targetInput;
                let actualType = typeOrIndexedType;
                let actualIdx = weaponIdx;

                if (typeOrIndexedType.startsWith('weapon-')) {
                    actualType = 'weapon';
                    actualIdx = typeOrIndexedType.split('-')[1];
                }

                if (actualType === 'magic') {
                    targetInput = document.getElementById('magic-power-input');
                } else {
                    targetInput = document.getElementById(`weapon-${actualIdx}-power`);
                }

                if (!targetInput) return;

                const powerStr = targetInput.value;
                if (powerStr === '') {
                    ratingTableContainer.className = 'rating-table-wrapper';
                    return;
                }

                const power = parseInt(powerStr, 10);
                if (isNaN(power) || power < 0 || power > 100) {
                    ratingTableContainer.className = 'rating-table-wrapper';
                    return;
                }

                // Generate table HTML
                const rowData = damageTable[power];
                if (!rowData) return;

                let html = `<div style="font-size: 0.7rem; color: #94a3b8; margin-bottom: 4px; text-align: left;">å¨åŠ›è¡¨: ${actualType === 'magic' ? 'é­”æ³•' : 'æ­¦å™¨' + actualIdx} (ãƒ¬ãƒ¼ãƒˆ${power})</div>`;
                html += '<table class="rating-table"><thead><tr>';
                // Headers 3 to 12
                for (let i = 3; i <= 12; i++) {
                    html += `<th>${i}</th>`;
                }
                html += '</tr></thead><tbody><tr>';
                // Values
                for (let i = 0; i < 10; i++) {
                    html += `<td>${rowData[i]}</td>`;
                }
                html += '</tr></tbody></table>';

                ratingTableContainer.innerHTML = html;
                ratingTableContainer.className = 'rating-table-wrapper show';
            }

            function rollDice(arg, fixedDice = null) {
                const isFate = (fixedDice !== null);
                // å¼•æ•°ãŒæ–‡å­—åˆ—ã§ãªã„ï¼ˆEventã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©ï¼‰å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ¤å®šã‚’è¡Œã†
                let type = (typeof arg === 'string') ? arg : 'weapon';

                // å¼•æ•°ãªã—ï¼ˆé€šå¸¸ãƒœã‚¿ãƒ³ï¼‰ã§2d6ã®å ´åˆã€å…¥åŠ›ãŒã‚ã‚‹æ­¦å™¨ã¾ãŸã¯é­”æ³•ã‚’è‡ªå‹•é¸æŠ
                if (type === 'weapon' && diceCount === 2) {
                    const mPowerInput = document.getElementById('magic-power-input');
                    const mPowerVal = mPowerInput ? mPowerInput.value : '';
                    if (mPowerVal !== '') {
                        type = 'magic';
                    } else {
                        for (let i = 1; i <= 4; i++) {
                            const pInput = document.getElementById(`weapon-${i}-power`);
                            if (pInput && pInput.value !== '') {
                                type = `weapon-${i}`;
                                break;
                            }
                        }
                    }
                }

                // Disable button during animation
                rollBtn.disabled = true;
                rollBtn.textContent = 'åˆ¤å®šä¸­...';

                // ãƒãƒ•ãƒ»ãƒ‡ãƒãƒ•ã®åˆè¨ˆå€¤ã‚’å–å¾—ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ã®å ´åˆã¯é©ç”¨å…ˆãŒ"all"ã¾ãŸã¯"pdmg"(ç‰©ç†)ãƒ»"mdmg"(é­”æ³•)ã®ã¿åˆç®—ï¼‰
                const targetDmgType = (type === 'magic') ? 'mdmg' : 'pdmg';
                const totalBuff = calculateTotalBuff(targetDmgType);

                // è¡¨ç¤ºã®åˆæœŸåŒ–
                diceContainer.innerHTML = '';
                totalScoreDisplay.className = 'total-score';
                totalScoreDisplay.textContent = '';

                // åˆ¤å®šé–‹å§‹æ™‚ã«å¨åŠ›è¡¨ã‚’æ›´æ–°
                updateRatingTable(type);

                // é‹å‘½å¤‰è»¢ãƒœã‚¿ãƒ³ã‚’ä¸€æ—¦éæ´»æ€§åŒ–
                fateBtn.disabled = true;

                let total = 0;
                const results = [];
                const diceElements = [];

                // ãƒ€ã‚¤ã‚¹ç”Ÿæˆ
                for (let i = 0; i < diceCount; i++) {
                    const die = document.createElement('div');
                    die.className = 'die show rolling';
                    die.textContent = Math.floor(Math.random() * 6) + 1;
                    diceContainer.appendChild(die);
                    diceElements.push(die);
                }

                // 2d6ã®å¨åŠ›è¨ˆç®—ç”¨å†å¸°é–¢æ•°
                function calculateDamage(power, crit, currentDmg, rollCnt, details, extraDice = [], originalLabel = '') {
                    if (typeof damageTable === 'undefined' || !damageTable[power]) return { damage: currentDmg, isAutoFail: false, rolls: details, extraDice };

                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const rollTotal = d1 + d2;
                    let newDmg = 0;

                    details.push(`${d1},${d2}(=${rollTotal})`);
                    extraDice.push(d1, d2);

                    // æŒ¯ã‚Šè¶³ã—ã§ã®2ã¯è‡ªå‹•å¤±æ•—ã§ã¯ãªã„ãŒã€å¨åŠ›è¡¨ã®è¨ˆç®—ã¯å¿…è¦
                    if (rollTotal > 2) {
                        newDmg = damageTable[power][rollTotal - 3] || 0;
                    }

                    const accumulated = currentDmg + newDmg;

                    if (rollTotal >= crit && rollTotal > 2) {
                        details[details.length - 1] += ' ã‚¯ãƒª!';
                        let nextPower = power;
                        if (originalLabel.includes('é¦–æ–¬ã‚Šåˆ€')) {
                            nextPower = Math.min(100, nextPower + 5);
                        }
                        return calculateDamage(nextPower, crit, accumulated, rollCnt + 1, details, extraDice, originalLabel);
                    } else {
                        return { damage: accumulated, isAutoFail: false, rolls: details, extraDice };
                    }
                }

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®å‡¦ç†
                setTimeout(() => {
                    for (let i = 0; i < diceCount; i++) {
                        const res = isFate ? fixedDice[i] : Math.floor(Math.random() * 6) + 1;
                        results.push(res);
                        total += res;
                        diceElements[i].className = 'die show' + (isFate ? ' fate' : '');
                        diceElements[i].textContent = res;
                    }

                    const isDiceOnly = document.getElementById('dice-only-checkbox') && document.getElementById('dice-only-checkbox').checked;

                    let finalResultText = `åˆè¨ˆ: ${total}`;
                    let isAutoFail = false;
                    let displayTotalStr = total.toString();
                    let historyRollsStr = results.join(', ');
                    let isDamageRollApplied = false;

                    // å‡ºç›®ã®ã¿å‡ºåŠ›ONã®å ´åˆã¯å¨åŠ›è¨ˆç®—ãªã©ã‚’ã™ã¹ã¦ã‚¹ã‚­ãƒƒãƒ—
                    if (isDiceOnly) {
                        finalResultText = `å‡ºç›®åˆè¨ˆ: ${total}`;
                        displayTotalStr = total.toString();
                        historyRollsStr = results.join(', ');
                    }
                    // å¨åŠ›è¨ˆç®—ãŒå¿…è¦ãªå ´åˆï¼ˆå‡ºç›®ã®ã¿å‡ºåŠ›ãŒOFFã§2d6ã®ã¨ãï¼‰
                    else if (diceCount === 2) {
                        let power, critValue, extraDmg = 0, label = 'åˆ¤å®š';
                        let inputVal = '';

                        if (type === 'magic') {
                            const pEl = document.getElementById('magic-power-input');
                            const cEl = document.getElementById('magic-crit-input');
                            const bEl = document.getElementById('magic-bonus-input');
                            if (pEl && pEl.value !== '') {
                                inputVal = pEl.value;
                                power = parseInt(inputVal, 10);
                                critValue = parseInt(cEl.value, 10) || 10;
                                if (document.getElementById('magic-no-crit').checked) critValue = 13;
                                extraDmg = parseInt(bEl.value, 10) || 0;
                                label = 'é­”æ³•';
                            }
                        } else if (type.startsWith('weapon-')) {
                            const idx = type.split('-')[1];
                            const pEl = document.getElementById(`weapon-${idx}-power`);
                            const cEl = document.getElementById(`weapon-${idx}-crit`);
                            const nEl = document.getElementById(`weapon-${idx}-name`);
                            const eEl = document.getElementById(`weapon-${idx}-extra-dmg`);
                            if (pEl && pEl.value !== '') {
                                inputVal = pEl.value;
                                power = parseInt(inputVal, 10);
                                critValue = parseInt(cEl.value, 10) || 10;
                                extraDmg = parseInt(eEl.value, 10) || 0;
                                label = nEl.value || `æ­¦å™¨${idx}`;
                            }
                        }

                        // å¨åŠ›ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã€ã‹ã¤damageTableãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—å®Ÿè¡Œ
                        if (inputVal !== '' && !isNaN(power) && typeof damageTable !== 'undefined' && damageTable[power]) {
                            isDamageRollApplied = true;
                            const firstD1 = results[0];
                            const firstD2 = results[1];
                            const firstTotal = firstD1 + firstD2;
                            let rollDetails = [`${firstD1},${firstD2}(=${firstTotal})`];

                            if (firstTotal === 2) {
                                finalResultText = `è‡ªå‹•å¤±æ•— (å‡ºç›®2)`;
                                isAutoFail = true;
                                displayTotalStr = 'è‡ªå‹•å¤±æ•—';
                                historyRollsStr = rollDetails[0];
                            } else {
                                let initialDmg = damageTable[power][firstTotal - 3] || 0;
                                const combinedBonus = totalBuff + extraDmg;
                                const modifierText = combinedBonus > 0 ? `+${combinedBonus}` : (combinedBonus < 0 ? `${combinedBonus}` : '');

                                if (firstTotal >= critValue) {
                                    rollDetails[0] += ' ã‚¯ãƒª!';
                                    let nextPower = power;
                                    if (label.includes('é¦–æ–¬ã‚Šåˆ€')) {
                                        nextPower = Math.min(100, nextPower + 5);
                                    }
                                    const critRes = calculateDamage(nextPower, critValue, initialDmg, 1, rollDetails, [], label);
                                    let finalDmgVal = (typeof critRes.damage === 'number') ? critRes.damage + combinedBonus : critRes.damage;

                                    // æŒ¯è¶³ã—ãƒ€ã‚¤ã‚¹è¡¨ç¤º
                                    if (critRes.extraDice && critRes.extraDice.length > 0) {
                                        const plus = document.createElement('div');
                                        plus.textContent = 'ï¼‹';
                                        plus.className = 'die show';
                                        plus.style.background = 'none';
                                        plus.style.boxShadow = 'none';
                                        plus.style.fontSize = '1.5rem';
                                        plus.style.color = 'var(--accent)';
                                        plus.style.display = 'flex';
                                        plus.style.alignItems = 'center';
                                        plus.style.margin = '0 10px';
                                        diceContainer.appendChild(plus);
                                        critRes.extraDice.forEach(v => {
                                            const d = document.createElement('div');
                                            d.className = 'die show';
                                            d.textContent = v;
                                            diceContainer.appendChild(d);
                                        });
                                    }
                                    finalResultText = `${label}ãƒ€ãƒ¡ãƒ¼ã‚¸: ${finalDmgVal} (å¨åŠ›${power}, ã‚¯ãƒª${critValue}${modifierText})`;
                                    displayTotalStr = finalDmgVal.toString();
                                    historyRollsStr = critRes.rolls.join(' ï¼ ') + (modifierText ? ` ä¿®æ­£${modifierText}` : '');
                                } else {
                                    const finalDmgVal = initialDmg + combinedBonus;
                                    finalResultText = `${label}ãƒ€ãƒ¡ãƒ¼ã‚¸: ${finalDmgVal} (å‡ºç›®${firstTotal}, å¨åŠ›${power}${modifierText})`;
                                    displayTotalStr = finalDmgVal.toString();
                                    historyRollsStr = rollDetails[0] + (modifierText ? ` ä¿®æ­£${modifierText}` : '');
                                }
                            }
                        }
                    }

                    // å¨åŠ›åˆ¤å®šã§ãªã„ã€ã¾ãŸã¯è¨ˆç®—ã•ã‚Œãªã‹ã£ãŸå ´åˆï¼ˆå‡ºç›®ã®ã¿ã®å ´åˆã¯ã“ã“ã‚’é€šã‚‹ãŒtotalBuffã¯åŠ ç®—ã—ãªã„ã‚ˆã†åˆ¶å¾¡ï¼‰
                    if (!isDamageRollApplied && !isDiceOnly) {
                        total += totalBuff;
                        const buffText = totalBuff > 0 ? `+${totalBuff}` : (totalBuff < 0 ? `${totalBuff}` : '');
                        finalResultText = `åˆè¨ˆ: ${total}${buffText ? ' (ãƒãƒ•' + buffText + ')' : ''}`;
                        historyRollsStr += (buffText ? ` ãƒãƒ•${buffText}` : '');
                        displayTotalStr = total.toString();
                    }

                    // çµæœè¡¨ç¤º
                    totalScoreDisplay.textContent = (isFate ? 'ã€é‹å‘½å¤‰è»¢ã€‘' : '') + finalResultText;
                    totalScoreDisplay.className = 'total-score show';
                    totalScoreDisplay.style.color = isFate ? '#10b981' : ((isAutoFail && !isDiceOnly) ? '#ef4444' : 'var(--accent)');
                    totalScoreDisplay.style.fontSize = (isAutoFail && !isDiceOnly) ? '2rem' : '1.8rem';

                    const rollResultData = {
                        isFate: isFate,
                        title: isDiceOnly ? "ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«" : (isDamageRollApplied ? finalResultText : "åˆ¤å®š"),
                        displayTotal: displayTotalStr,
                        historyRolls: historyRollsStr,
                        isAutoFail: isDiceOnly ? false : isAutoFail
                    };

                    addToHistory(diceCount, historyRollsStr, displayTotalStr, isAutoFail);
                    sendToDiscord(rollResultData);
                    rollBtn.disabled = false;
                    rollBtn.textContent = 'ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹';

                    // 2d6ãƒ­ãƒ¼ãƒ«ã®å ´åˆã®ã¿é‹å‘½å¤‰è»¢ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    if (results.length === 2 && !isFate) {
                        lastRollData = {
                            type: 'damage',
                            rollType: type,
                            dice: [...results],
                            diceCount: diceCount
                        };
                        fateBtn.disabled = false;
                    } else {
                        fateBtn.disabled = true;
                    }
                }, 600);
            }

            // é‹å‘½å¤‰è»¢ã®å®Ÿè¡Œ
            fateBtn.addEventListener('click', () => {
                if (!lastRollData) return;

                const flippedDice = lastRollData.dice.map(v => 7 - v);
                const isFate = true;

                if (lastRollData.type === 'damage') {
                    rollDice(lastRollData.rollType, flippedDice);
                } else if (lastRollData.type === 'hit') {
                    rollHitCheck(lastRollData.label, lastRollData.base, flippedDice);
                } else if (lastRollData.type === 'check') {
                    rollCheck(lastRollData.stat, lastRollData.skill, lastRollData.base, flippedDice);
                }

                fateBtn.disabled = true;
            });

            rollBtn.addEventListener('click', () => rollDice());

            function addToHistory(count, rollsStr, totalStr, isAutoFail = false) {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';

                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

                const colorStyle = isAutoFail ? 'color: #ef4444;' : 'color: var(--text-color);';

                historyItem.innerHTML = `
                    <span>[${timeString}] ${count}d6 ï¼ [${rollsStr}]</span>
                    <strong style="${colorStyle}">â†’ ${totalStr}</strong>
                `;

                historyContainer.insertBefore(historyItem, historyContainer.firstChild);

                // Keep only last 10 items
                if (historyContainer.children.length > 10) {
                    historyContainer.removeChild(historyContainer.lastChild);
                }
            }

            // å‘½ä¸­åˆ¤å®šãƒ»å¨åŠ›åˆ¤å®šã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå‹•çš„ã«å‰²ã‚Šå½“ã¦ï¼‰
            document.querySelectorAll('.weapon-hit-label, .weapon-hit-calc-btn').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const idx = el.getAttribute('data-index');
                    const hitBase = parseInt(document.getElementById(`weapon-${idx}-hit`).value, 10) || 0;
                    const weaponName = document.getElementById(`weapon-${idx}-name`).value || `æ­¦å™¨${idx}`;
                    rollHitCheck(weaponName, hitBase);
                });
            });

            document.querySelectorAll('.weapon-power-label, .weapon-calc-btn').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const idx = el.getAttribute('data-index');
                    const powerVal = document.getElementById(`weapon-${idx}-power`).value;
                    if (powerVal === '' || isNaN(parseInt(powerVal, 10))) {
                        alert('å¨åŠ›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    // ãƒ€ã‚¤ã‚¹æ•°ã‚’2d6ã«ã‚»ãƒƒãƒˆ
                    diceCount = 2;
                    updateDiceCountDisplay(`weapon`, idx);
                    // ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
                    rollDice(`weapon-${idx}`);
                });
            });

            const magicTriggerIds = ['magic-power-label', 'magic-calc-btn'];
            magicTriggerIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const powerVal = document.getElementById('magic-power-input').value;
                        if (powerVal === '' || isNaN(parseInt(powerVal, 10))) {
                            alert('é­”æ³•å¨åŠ›ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                        // ãƒ€ã‚¤ã‚¹æ•°ã‚’2d6ã«ã‚»ãƒƒãƒˆ
                        diceCount = 2;
                        updateDiceCountDisplay('magic');
                        // ãƒ€ãƒ¡ãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
                        rollDice('magic');
                    });
                }
            });

            // é­”æ³•è¡Œä½¿åˆ¤å®šã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            const magicCastBtn = document.getElementById('magic-cast-btn');
            if (magicCastBtn) {
                magicCastBtn.addEventListener('click', () => {
                    const magicBonusInput = document.getElementById('magic-bonus-input');
                    const magicPower = parseInt(magicBonusInput.value, 10) || 0;
                    rollCheck('é­”æ³•è¡Œä½¿', 'çŸ¥åŠ›', magicPower);
                });
            }

            function rollHitCheck(weaponName, hitBase, fixedDice = null) {
                const isFate = (fixedDice !== null);
                rollBtn.disabled = true;
                rollBtn.textContent = 'åˆ¤å®šä¸­...';
                fateBtn.disabled = true;

                // Calculate total buffs/debuffs
                const totalBuff = calculateTotalBuff('hit');

                diceContainer.innerHTML = '';
                totalScoreDisplay.className = 'total-score';
                totalScoreDisplay.textContent = '';

                const d1 = isFate ? fixedDice[0] : Math.floor(Math.random() * 6) + 1;
                const d2 = isFate ? fixedDice[1] : Math.floor(Math.random() * 6) + 1;
                const diceTotal = d1 + d2;

                [d1, d2].forEach(val => {
                    const die = document.createElement('div');
                    die.className = 'die show rolling';
                    die.textContent = val;
                    diceContainer.appendChild(die);
                });

                setTimeout(() => {
                    document.querySelectorAll('.die').forEach(el => el.classList.remove('rolling'));

                    const isDiceOnly = document.getElementById('dice-only-checkbox') && document.getElementById('dice-only-checkbox').checked;

                    let isAutoFail = (diceTotal === 2);
                    let isAutoSuccess = (diceTotal === 12);

                    let finalResult, resultText, detailStr, rollTitle, textColor;

                    if (isDiceOnly) {
                        finalResult = diceTotal;
                        resultText = diceTotal;
                        detailStr = `${diceTotal}[${d1},${d2}]`;
                        rollTitle = "ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«";
                        textColor = 'var(--text-color)';
                        isAutoFail = false;
                        isAutoSuccess = false;
                    } else {
                        finalResult = isAutoFail ? 0 : diceTotal + hitBase + totalBuff;
                        resultText = isAutoFail ? 'è‡ªå‹•å¤±æ•—' : (isAutoSuccess ? `è‡ªå‹•æˆåŠŸ (${finalResult})` : finalResult);
                        detailStr = `${diceTotal}[${d1},${d2}] + ${hitBase}`;
                        if (totalBuff !== 0) detailStr += (totalBuff > 0 ? ` + ${totalBuff}` : ` - ${Math.abs(totalBuff)}`);
                        rollTitle = `${weaponName}å‘½ä¸­åˆ¤å®š`;
                        textColor = isAutoFail ? '#ef4444' : (isAutoSuccess ? '#fbbf24' : 'var(--accent)');
                    }

                    totalScoreDisplay.textContent = (isFate ? 'ã€é‹å‘½å¤‰è»¢ã€‘' : '') + (isDiceOnly ? `å‡ºç›®åˆè¨ˆ: ${resultText}` : `${rollTitle}: ${resultText}`);
                    totalScoreDisplay.style.color = isFate ? '#10b981' : textColor;
                    totalScoreDisplay.style.fontSize = '1.5rem';
                    totalScoreDisplay.className = 'total-score show';

                    const rollResultData = {
                        isFate: isFate,
                        title: rollTitle,
                        displayTotal: resultText,
                        historyRolls: detailStr,
                        isAutoFail: isAutoFail,
                        targetType: isDiceOnly ? 'none' : 'hit'
                    };

                    addToHistory(2, (isFate ? 'é‹å‘½å¤‰è»¢:' : '') + (isDiceOnly ? detailStr : `${weaponName}å‘½ä¸­ ${detailStr}`), resultText, isAutoFail);
                    sendToDiscord(rollResultData);

                    rollBtn.disabled = false;
                    rollBtn.textContent = 'ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹';

                    if (!isFate) {
                        lastRollData = {
                            type: 'hit',
                            label: weaponName,
                            base: hitBase,
                            dice: [d1, d2]
                        };
                        fateBtn.disabled = false;
                    } else {
                        fateBtn.disabled = true;
                    }
                }, 600);
            }

            // åˆ¤å®šæ©Ÿèƒ½ã®å¤‰æ•°
            let selectedStat = null;
            let selectedSkill = null;

            // èƒ½åŠ›å€¤ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.clickable-stat').forEach(el => {
                el.addEventListener('click', () => {
                    if (selectedStat === el) {
                        el.classList.remove('selected-item');
                        selectedStat = null;
                    } else {
                        if (selectedStat) selectedStat.classList.remove('selected-item');
                        el.classList.add('selected-item');
                        selectedStat = el;
                        checkAndRollCheck();
                    }
                });
            });

            // æŠ€èƒ½ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.clickable-skill').forEach(el => {
                el.addEventListener('click', (e) => {
                    // inputæ¬„ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯é¸æŠå‡¦ç†ã‚’è¡Œã‚ãªã„
                    if (e.target.tagName.toLowerCase() === 'input') return;

                    if (selectedSkill === el) {
                        el.classList.remove('selected-item');
                        selectedSkill = null;
                    } else {
                        if (selectedSkill) selectedSkill.classList.remove('selected-item');
                        el.classList.add('selected-item');
                        selectedSkill = el;
                        checkAndRollCheck();
                    }
                });
            });

            function checkAndRollCheck() {
                if (selectedStat && selectedSkill) {
                    const statKey = selectedStat.getAttribute('data-stat');
                    const bonusInput = document.getElementById(`bonus-${statKey}`);
                    const bonus = parseInt(bonusInput.value, 10) || 0;

                    const skillId = selectedSkill.getAttribute('data-skill-id');
                    const skillNameInput = document.getElementById(`skill-name-${skillId}`);
                    const skillLvInput = document.getElementById(`skill-lv-${skillId}`);
                    const skillName = skillNameInput.value || 'æŠ€èƒ½ãªã—';
                    const skillLv = parseInt(skillLvInput.value, 10) || 0;

                    const statNames = { dex: 'å™¨ç”¨åº¦', agi: 'æ•æ·åº¦', str: 'ç­‹åŠ›', vit: 'ç”Ÿå‘½åŠ›', int: 'çŸ¥åŠ›', mnd: 'ç²¾ç¥åŠ›' };
                    const statName = statNames[statKey] || 'èƒ½åŠ›å€¤';
                    const baseMod = bonus + skillLv;

                    // 2d6ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè¡Œ
                    rollCheck(statName, skillName, baseMod);

                    // é¸æŠã‚’è§£é™¤
                    selectedStat.classList.remove('selected-item');
                    selectedSkill.classList.remove('selected-item');
                    selectedStat = null;
                    selectedSkill = null;
                }
            }

            function rollCheck(statName, skillName, baseMod, fixedDice = null) {
                const isFate = (fixedDice !== null);
                rollBtn.disabled = true;
                rollBtn.textContent = 'åˆ¤å®šä¸­...';
                fateBtn.disabled = true;

                // Calculate total buffs/debuffs
                let rollTargetType = 'all';
                if (statName.includes('å›é¿')) rollTargetType = 'dodge';
                else if (statName.includes('ç”Ÿå‘½åŠ›')) rollTargetType = 'vit';
                else if (statName.includes('çŸ¥åŠ›') || statName.includes('é­”æ³•è¡Œä½¿')) rollTargetType = 'int';
                else if (statName.includes('ç²¾ç¥åŠ›')) rollTargetType = 'mnd';
                const totalBuff = calculateTotalBuff(rollTargetType);
                diceContainer.innerHTML = '';
                totalScoreDisplay.className = 'total-score';
                totalScoreDisplay.textContent = '';

                const d1 = isFate ? fixedDice[0] : Math.floor(Math.random() * 6) + 1;
                const d2 = isFate ? fixedDice[1] : Math.floor(Math.random() * 6) + 1;
                const diceTotal = d1 + d2;

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ€ã‚¤ã‚¹è¡¨ç¤º
                [d1, d2].forEach(val => {
                    const die = document.createElement('div');
                    die.className = 'die show rolling';
                    die.textContent = val;
                    diceContainer.appendChild(die);
                });

                setTimeout(() => {
                    document.querySelectorAll('.die').forEach(el => el.classList.remove('rolling'));

                    const isDiceOnly = document.getElementById('dice-only-checkbox') && document.getElementById('dice-only-checkbox').checked;

                    let isAutoFail = (diceTotal === 2);
                    let finalResult, resultText, detailStr, rollTitle, textColor;

                    if (isDiceOnly) {
                        finalResult = diceTotal;
                        resultText = diceTotal;
                        detailStr = `${diceTotal}[${d1},${d2}]`;
                        rollTitle = "ãƒ€ã‚¤ã‚¹ãƒ­ãƒ¼ãƒ«";
                        textColor = 'var(--text-color)';
                        isAutoFail = false;
                    } else {
                        finalResult = isAutoFail ? 0 : diceTotal + baseMod + totalBuff;
                        resultText = isAutoFail ? 'è‡ªå‹•å¤±æ•—' : finalResult;
                        detailStr = `${diceTotal}[${d1},${d2}] + ${baseMod}`;
                        if (totalBuff !== 0) detailStr += (totalBuff > 0 ? ` + ${totalBuff}` : ` - ${Math.abs(totalBuff)}`);
                        rollTitle = `${statName}åˆ¤å®š (${skillName})`;
                        textColor = isAutoFail ? '#ef4444' : 'var(--accent)';
                    }

                    totalScoreDisplay.textContent = (isFate ? 'ã€é‹å‘½å¤‰è»¢ã€‘' : '') + (isDiceOnly ? `å‡ºç›®åˆè¨ˆ: ${resultText}` : `${statName}/${skillName}åˆ¤å®š: ${resultText}`);
                    totalScoreDisplay.style.color = isFate ? '#10b981' : textColor;
                    totalScoreDisplay.style.fontSize = '1.5rem';
                    totalScoreDisplay.className = 'total-score show';

                    const rollResultData = {
                        isFate: isFate,
                        title: rollTitle,
                        displayTotal: resultText,
                        historyRolls: isDiceOnly ? detailStr : `${diceTotal}[${d1},${d2}] + ${baseMod}`,
                        isAutoFail: isAutoFail,
                        targetType: isDiceOnly ? 'none' : rollTargetType,
                        totalBuff: isDiceOnly ? 0 : totalBuff
                    };

                    addToHistory(2, (isFate ? 'é‹å‘½å¤‰è»¢:' : '') + (isDiceOnly ? detailStr : `${statName}/${skillName} ${detailStr}`), resultText, isAutoFail);
                    sendToDiscord(rollResultData);

                    rollBtn.disabled = false;
                    rollBtn.textContent = 'ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹';

                    if (!isFate) {
                        lastRollData = {
                            type: 'check',
                            stat: statName,
                            skill: skillName,
                            base: baseMod,
                            dice: [d1, d2]
                        };
                        fateBtn.disabled = false;
                    } else {
                        fateBtn.disabled = true;
                    }
                }, 600);
            }
        });
    </script>
</body>

</html>